<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Payslip Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        header {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #2c53ff;
            padding: 20px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #ffffff;
        }

        .form-container {
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            transition: color 0.3s ease;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        .earnings-deductions {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .earnings, .deductions {
            flex: 1;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            color: #444;
        }

        .add-item {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }

        .remove-item {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 2px 6px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

        .items-list {
            margin-top: 10px;
        }

        .item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .item input {
            flex: 1;
            margin-right: 10px;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-generate {
            background-color: #4CAF50;
            color: white;
        }

        .btn-clear {
            background-color: #f44336;
            color: white;
        }

        .btn-save {
            background-color: #2196F3;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .payslip-list {
            margin-top: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .action-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }

        .action-btn.delete {
            background-color: #f44336;
        }

        .notification {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: white;
            display: none;
        }

        .success {
            background-color: #4CAF50;
        }

        .error {
            background-color: #f44336;
        }

        .preview-container {
            display: none;
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }

        .payslip-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .payslip-header h2 {
            margin-bottom: 5px;
            color: #333;
        }

        .payslip-header p {
            color: #666;
        }

        .payslip-details {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .detail-col {
            flex: 1;
            min-width: 250px;
            margin-bottom: 15px;
        }

        .detail-item {
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: bold;
            display: inline-block;
            width: 150px;
            color: #555;
        }

        .payslip-table {
            width: 100%;
            margin-bottom: 20px;
        }

        .payslip-total {
            text-align: right;
            font-weight: bold;
            margin-top: 10px;
            font-size: 16px;
        }

        .payslip-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #777;
        }

        .preview-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .earnings-deductions {
                flex-direction: column;
            }
            .form-col, .earnings, .deductions {
                width: 100%;
            }
        }

        .error-message {
            color: red;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <header>
        <h1>HR PAYSLIP GENERATOR</h1>
    </header>
    <div class="container">
        <div class="notification success" id="success-notification"></div>
        <div class="notification error" id="error-notification"></div>
        
        <div class="form-container" id="form-container">
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="employee-id">Employee ID:</label>
                        <input type="text" id="employee-id" placeholder="e.g., ATS0123" maxlength="7">
                        <span class="error-message" id="employee-id-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="employee-name">Employee Name:</label>
                        <input type="text" id="employee-name" placeholder="Full Name" maxlength="30">
                        <span class="error-message" id="employee-name-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="designation">Designation:</label>
                        <input type="text" id="designation" placeholder="e.g., Software Testing Engineer" maxlength="30">
                        <span class="error-message" id="designation-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="date-joining">Date of Joining:</label>
                        <input type="date" id="date-joining">
                        <span class="error-message" id="date-joining-error"></span>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="month-year">Month and Year:</label>
                        <input type="month" id="month-year" style="height: 42px;">
                        <span class="error-message" id="month-year-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="employee-type">Employee Type:</label>
                        <select id="employee-type">
                            <option value="Permanent">Permanent</option>
                            <option value="Contract">Contract</option>
                            <option value="Temporary">Temporary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="location">Current Office Location:</label>
                        <input type="text" id="location" placeholder="e.g., Hyderabad" maxlength="30">
                        <span class="error-message" id="location-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="pan">PAN No:</label>
                        <input type="text" id="pan" placeholder="e.g., ABCDE1234F" maxlength="10">
                        <span class="error-message" id="pan-error"></span>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="bank-name">Bank Name:</label>
                        <input type="text" id="bank-name" placeholder="e.g., INDIAN BANK" maxlength="30">
                        <span class="error-message" id="bank-name-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="account-no">Bank Account No:</label>
                        <input type="text" id="account-no" placeholder="e.g., 1234567890" maxlength="16">
                        <span class="error-message" id="account-no-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="working-days">Working Days:</label>
                        <input type="number" id="working-days" min="0" max="31">
                        <span class="error-message" id="working-days-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="lop">LOP (Loss of Pay):</label>
                        <input type="number" id="lop" min="0">
                        <span class="error-message" id="lop-error"></span>
                    </div>
                </div>
            </div>
            
            <div class="earnings-deductions">
                <div class="earnings">
                    <h3>Earnings</h3>
                    <div class="items-list" id="earnings-list">
                        <div class="item">
                            <input type="text" placeholder="Component name" value="Basic" class="component-name">
                            <input type="number" placeholder="Amount" min="0" class="component-amount">
                            <button type="button" class="remove-item">✕</button>
                        </div>
                        <div class="item">
                            <input type="text" placeholder="Component name" value="House Rent Allowance" class="component-name">
                            <input type="number" placeholder="Amount" min="0" class="component-amount">
                            <button type="button" class="remove-item">✕</button>
                        </div>
                    </div>
                    <button type="button" class="add-item" id="add-earning">Add Earning</button>
                </div>
                <div class="deductions">
                    <h3>Deductions</h3>
                    <div class="items-list" id="deductions-list">
                        <div class="item">
                            <input type="text" placeholder="Component name" value="Professional Tax" class="component-name">
                            <input type="number" placeholder="Amount" min="0" class="component-amount">
                            <button type="button" class="remove-item">✕</button>
                        </div>
                    </div>
                    <button type="button" class="add-item" id="add-deduction">Add Deduction</button>
                </div>
            </div>
            
            <div class="buttons">
                <button type="button" class="btn btn-clear" id="clear-form">Clear Form</button>
                <button type="button" class="btn btn-generate" id="preview-payslip">Preview Payslip</button>
                <button type="button" class="btn btn-save" id="save-payslip">Generate & Save</button>
            </div>
        </div>
        
        <div class="preview-container" id="preview-container">
            <div class="payslip-header">
                <h2>Astrolite Tech Solutions Pvt Ltd</h2>
                <p>Plot No 65, Flat No 201, 2nd Floor, Siddivinayaka Nagar, Survey of India, Madhapur, HYDERABAD -081</p>
                <h3>Salary Slip for <span id="preview-month-year"></span></h3>
            </div>
            
            <div class="payslip-details">
                <div class="detail-col">
                    <div class="detail-item">
                        <span class="detail-label">Employee Name:</span>
                        <span id="preview-name"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Designation:</span>
                        <span id="preview-designation"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date of Joining:</span>
                        <span id="preview-doj"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Bank Name:</span>
                        <span id="preview-bank"></span>
                    </div>
                </div>
                <div class="detail-col">
                    <div class="detail-item">
                        <span class="detail-label">Employee Type:</span>
                        <span id="preview-type"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span id="preview-duration"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Working Days:</span>
                        <span id="preview-working-days"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Bank Account No:</span>
                        <span id="preview-account"></span>
                    </div>
                </div>
                <div class="detail-col">
                    <div class="detail-item">
                        <span class="detail-label">Employee Code:</span>
                        <span id="preview-id"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Current Office:</span>
                        <span id="preview-location"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">LOP:</span>
                        <span id="preview-lop"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">PAN No:</span>
                        <span id="preview-pan"></span>
                    </div>
                </div>
            </div>
            
            <div class="earnings-deductions">
                <div class="earnings">
                    <h3>Earnings</h3>
                    <table class="payslip-table">
                        <thead>
                            <tr>
                                <th>Components</th>
                                <th>Amount (Rs.)</th>
                            </tr>
                        </thead>
                        <tbody id="preview-earnings-table">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>Gross Pay (A)</strong></td>
                                <td><strong id="preview-gross-pay">0</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="deductions">
                    <h3>Deductions</h3>
                    <table class="payslip-table">
                        <thead>
                            <tr>
                                <th>Common Deductions</th>
                                <th>Amount (Rs.)</th>
                            </tr>
                        </thead>
                        <tbody id="preview-deductions-table">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>Total Deductions (B)</strong></td>
                                <td><strong id="preview-total-deductions">0</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="payslip-total">
                Net Pay (A - B): Rs. <span id="preview-net-pay">0</span>
            </div>
            
            <div id="preview-amount-in-words" style="margin-top: 10px; font-style: italic;"></div>
            
            <div class="payslip-footer">
                <p>Note: This is a Computer-Generated Slip and does not require signature</p>
            </div>
            
            <div class="preview-actions">
                <button type="button" class="btn btn-clear" id="close-preview">Back to Form</button>
                <button type="button" class="btn btn-save" id="download-payslip">Download PDF</button>
            </div>
        </div>
        
        <div class="payslip-list">
            <h2>Generated Payslips</h2>
            <table>
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Employee Name</th>
                        <th>Month & Year</th>
                        <th>Net Pay</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="payslips-table">
                    <!-- Payslips will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Hide preview container by default
    document.getElementById('preview-container').style.display = 'none';
    
    // Initialize the localStorage if it doesn't exist
    if (!localStorage.getItem('payslips')) {
        localStorage.setItem('payslips', JSON.stringify([]));
    }

    // Load existing payslips
    loadPayslips();

    // Set min and max for month-year input
    const monthYearInput = document.getElementById('month-year');
    const currentDate = new Date();
    const maxMonth = currentDate.toISOString().slice(0, 7); // Current month (YYYY-MM)
    const minDate = new Date(currentDate.getFullYear() - 1, currentDate.getMonth(), 1);
    const minMonth = minDate.toISOString().slice(0, 7); // 12 months ago (YYYY-MM)
    monthYearInput.setAttribute('min', minMonth);
    monthYearInput.setAttribute('max', maxMonth);

    // LOP Deduction Calculation Function
    function calculateLOPDeduction(grossPay, workingDays, lop) {
        if (isNaN(grossPay) || isNaN(workingDays) || isNaN(lop)) {
            return 0;
        }
        if (workingDays === 0) {
            return 0;
        }
        const dailyRate = grossPay / workingDays;
        const lopDeduction = dailyRate * lop;
        return Math.round(lopDeduction * 100) / 100;
    }

    // Setup Input Restrictions and Real-time Validation
    function setupInputRestrictions() {
        const inputs = [
            { id: 'employee-id', regex: /[^A-Z0-9]/g, transform: 'toUpperCase', max: 7, validate: validateEmployeeId, errorId: 'employee-id-error' },
            { id: 'employee-name', regex: /[^A-Za-z\s]/g, max: 30, validate: validateAlphabeticWithSpaces, errorId: 'employee-name-error' },
            { id: 'designation', regex: /[^A-Za-z\s]/g, max: 30, validate: validateAlphabeticWithSpaces, errorId: 'designation-error' },
            { id: 'location', regex: /[^A-Za-z\s]/g, max: 30, validate: validateAlphabeticWithSpaces, errorId: 'location-error' },
            { id: 'bank-name', regex: /[^A-Za-z\s]/g, transform: 'toUpperCase', max: 30, validate: validateAlphabeticWithSpaces, errorId: 'bank-name-error' },
            { id: 'pan', regex: /[^A-Z0-9]/g, transform: 'toUpperCase', max: 10, validate: validatePAN, errorId: 'pan-error' },
            { id: 'account-no', regex: /\D/g, max: 16, validate: validateBankAccount, errorId: 'account-no-error' },
            { id: 'working-days', regex: /\D/g, max: 31, validate: validateWorkingDays, errorId: 'working-days-error' },
            { id: 'lop', regex: /\D/g, validate: null, errorId: 'lop-error' }
        ];

        inputs.forEach(input => {
            const element = document.getElementById(input.id);
            element.addEventListener('input', function(e) {
                let value = e.target.value.replace(input.regex, '');
                if (input.transform) value = value[input.transform]();
                
                if (['employee-name', 'designation', 'location', 'bank-name'].includes(input.id)) {
                    value = value.replace(/^\s+/, '');
                    value = value.replace(/\s+/g, ' '); // Replace multiple spaces with single space
                    if (!/[A-Za-z]/.test(value)) value = value.replace(/\s/g, '');
                }

                if (input.max) value = value.slice(0, input.max);
                if (input.id === 'working-days') {
                    value = Math.min(Math.max(0, parseInt(value) || 0), 31);
                }
                e.target.value = value;

                const errorElement = document.getElementById(input.errorId);
                if (input.validate) {
                    if (!input.validate(value)) {
                        errorElement.textContent = getErrorMessage(input.id);
                    } else {
                        errorElement.textContent = '';
                    }
                }
            });
        });

        document.getElementById('date-joining').addEventListener('input', function(e) {
            const errorElement = document.getElementById('date-joining-error');
            const today = new Date();
            const minDate = new Date('1990-01-01');
            const joiningDate = new Date(e.target.value);
            if (!e.target.value || joiningDate > today || joiningDate < minDate) {
                errorElement.textContent = 'Joining date must be between Jan 1, 1990 and today';
            } else {
                errorElement.textContent = '';
            }
        });

        document.getElementById('month-year').addEventListener('input', function(e) {
            const errorElement = document.getElementById('month-year-error');
            const selectedDate = new Date(e.target.value);
            const minAllowedDate = new Date(minMonth);
            const maxAllowedDate = new Date(maxMonth);
            
            if (!e.target.value) {
                errorElement.textContent = 'Month and Year are required';
            } else if (selectedDate < minAllowedDate || selectedDate > maxAllowedDate) {
                errorElement.textContent = 'Select a month within the past 12 months or current month';
                e.target.value = '';
            } else {
                errorElement.textContent = '';
            }
        });

        const setupComponentRestrictions = (list) => {
            list.addEventListener('input', function(e) {
                if (e.target.classList.contains('component-name')) {
                    let value = e.target.value.replace(/[^A-Za-z\s]/g, '');
                    value = value.replace(/^\s+/, '');
                    value = value.replace(/\s+/g, ' '); // Replace multiple spaces with single space
                    if (!/[A-Za-z]/.test(value)) value = value.replace(/\s/g, '');
                    e.target.value = value.slice(0, 30);
                    const isValid = validateComponentName(e.target.value);
                    e.target.style.borderColor = isValid ? '#bdc3c7' : 'red';
                    // Display error message below the input
                    const errorElement = e.target.nextElementSibling?.nextElementSibling;
                    if (!isValid) {
                        if (!errorElement || !errorElement.classList.contains('error-message')) {
                            const errorSpan = document.createElement('span');
                            errorSpan.className = 'error-message';
                            errorSpan.textContent = 'Component name must contain at least 5 letters';
                            e.target.parentElement.appendChild(errorSpan);
                        }
                    } else {
                        if (errorElement && errorElement.classList.contains('error-message')) {
                            errorElement.remove();
                        }
                    }
                }
                if (e.target.classList.contains('component-amount')) {
                    let value = e.target.value.replace(/\D/g, '');
                    // Limit to 7 digits
                    value = value.slice(0, 7);
                    e.target.value = value;
                    const amount = parseFloat(value);
                    const isValid = value !== '' && !isNaN(amount) && amount >= 0 && value.length <= 7;
                    e.target.style.borderColor = isValid ? '#bdc3c7' : 'red';
                    // Display error message below the input
                    const errorElement = e.target.nextElementSibling?.nextElementSibling;
                    if (!isValid) {
                        if (!errorElement || !errorElement.classList.contains('error-message')) {
                            const errorSpan = document.createElement('span');
                            errorSpan.className = 'error-message';
                            errorSpan.textContent = 'Amount must be a positive number (max 7 digits)';
                            e.target.parentElement.appendChild(errorSpan);
                        }
                    } else {
                        if (errorElement && errorElement.classList.contains('error-message')) {
                            errorElement.remove();
                        }
                    }
                }
            });
        };

        setupComponentRestrictions(document.getElementById('earnings-list'));
        setupComponentRestrictions(document.getElementById('deductions-list'));
    }

    setupInputRestrictions();

    document.getElementById('add-earning').addEventListener('click', function() { addItem('earnings-list'); });
    document.getElementById('add-deduction').addEventListener('click', function() { addItem('deductions-list'); });
    document.getElementById('preview-payslip').addEventListener('click', previewPayslip);
    document.getElementById('save-payslip').addEventListener('click', savePayslip);
    document.getElementById('clear-form').addEventListener('click', clearForm);
    document.getElementById('close-preview').addEventListener('click', closePreview);
    document.getElementById('download-payslip').addEventListener('click', downloadPayslip);

    function validateEmployeeId(id) {
        const employeeIdRegex = /^ATS0(?!000)\d{3}$/;
        return employeeIdRegex.test(id.trim());
    }

    function validateAlphabeticWithSpaces(input) {
        const alphabetRegex = /^[A-Za-z]+(?:\s[A-Za-z]+)*$/;
        const alphaCount = (input.match(/[A-Za-z]/g) || []).length;
        const trimmedInput = input.trim();
        return trimmedInput.length >= 5 && 
               trimmedInput.length <= 30 && 
               alphabetRegex.test(trimmedInput) && 
               alphaCount >= 5 &&
               /[A-Za-z]/.test(trimmedInput);
    }

    function validatePAN(pan) {
        const panRegex = /^[A-Z]{5}\d{4}[A-Z]$/;
        return panRegex.test(pan.trim());
    }

    function validateBankAccount(account) {
        const accountRegex = /^\d{9,16}$/;
        return accountRegex.test(account.trim());
    }

    function validateWorkingDays(days) {
        const daysNum = parseInt(days);
        return !isNaN(daysNum) && daysNum >= 0 && daysNum <= 31;
    }

    function validateComponentName(name) {
        return validateAlphabeticWithSpaces(name);
    }

    function getErrorMessage(fieldId) {
        const messages = {
            'employee-id': 'Must start with ATS0 followed by 3 digits (not 000)',
            'employee-name': 'Must contain at least 5 alphabetic characters (max 30)',
            'designation': 'Must contain at least 5 alphabetic characters (max 30)',
            'location': 'Must contain at least 5 alphabetic characters (max 30)',
            'bank-name': 'Must contain at least 5 alphabetic characters (max 30)',
            'pan': 'Invalid PAN format (e.g., ABCDE1234F)',
            'account-no': 'Must be 9-16 digits',
            'working-days': 'Must be between 0-31'
        };
        return messages[fieldId] || 'Invalid input';
    }

    function validateEarningsAndDeductions() {
        let isValid = true;
        const earningsList = document.getElementById('earnings-list');
        const deductionsList = document.getElementById('deductions-list');
        let errorMessage = '';

        const earningsItems = earningsList.querySelectorAll('.item');
        if (earningsItems.length === 0) {
            errorMessage += 'At least one earning is required. ';
            isValid = false;
        }

        earningsItems.forEach(item => {
            const nameInput = item.querySelector('.component-name');
            const amountInput = item.querySelector('.component-amount');
            
            if (!validateComponentName(nameInput.value)) {
                isValid = false;
                errorMessage += 'Earnings: Invalid component name (min 5 letters). ';
            }
            
            const amount = parseFloat(amountInput.value);
            if (!amountInput.value || isNaN(amount) || amount < 0) {
                isValid = false;
                errorMessage += 'Earnings: Amount must be a positive number. ';
            }
        });

        deductionsList.querySelectorAll('.item').forEach(item => {
            const nameInput = item.querySelector('.component-name');
            const amountInput = item.querySelector('.component-amount');
            
            if (!validateComponentName(nameInput.value)) {
                isValid = false;
                errorMessage += 'Deductions: Invalid component name (min 5 letters). ';
            }
            
            const amount = parseFloat(amountInput.value);
            if (!amountInput.value || isNaN(amount) || amount < 0) {
                isValid = false;
                errorMessage += 'Deductions: Amount must be a positive number. ';
            }
        });

        if (!isValid) {
            document.getElementById('error-notification').textContent = errorMessage;
            document.getElementById('error-notification').style.display = 'block';
        }

        return isValid;
    }

    function validateForm() {
        let isValid = true;
        const fields = [
            { id: 'employee-id', validate: validateEmployeeId },
            { id: 'employee-name', validate: validateAlphabeticWithSpaces },
            { id: 'designation', validate: validateAlphabeticWithSpaces },
            { id: 'location', validate: validateAlphabeticWithSpaces },
            { id: 'bank-name', validate: validateAlphabeticWithSpaces },
            { id: 'pan', validate: validatePAN },
            { id: 'account-no', validate: validateBankAccount },
            { id: 'working-days', validate: validateWorkingDays }
        ];

        document.getElementById('error-notification').style.display = 'none';

        fields.forEach(field => {
            const value = document.getElementById(field.id).value;
            const errorElement = document.getElementById(`${field.id}-error`);
            if (!field.validate(value)) {
                errorElement.textContent = getErrorMessage(field.id);
                isValid = false;
            } else {
                errorElement.textContent = '';
            }
        });

        const dateJoining = document.getElementById('date-joining').value;
        const dateJoiningError = document.getElementById('date-joining-error');
        const today = new Date();
        const minDate = new Date('1990-01-01');
        const joiningDate = new Date(dateJoining);
        if (!dateJoining || joiningDate > today || joiningDate < minDate) {
            dateJoiningError.textContent = 'Joining date must be between Jan 1, 1990 and today';
            isValid = false;
        } else {
            dateJoiningError.textContent = '';
        }

        const monthYear = document.getElementById('month-year').value;
        const monthYearError = document.getElementById('month-year-error');
        const selectedDate = new Date(monthYear);
        const minAllowedDate = new Date(minMonth);
        const maxAllowedDate = new Date(maxMonth);

        if (!monthYear) {
            monthYearError.textContent = 'Month and Year are required';
            isValid = false;
        } else if (selectedDate < minAllowedDate || selectedDate > maxAllowedDate) {
            monthYearError.textContent = 'Select a month within the past 12 months or current month';
            isValid = false;
        } else {
            monthYearError.textContent = '';
        }

        if (!validateEarningsAndDeductions()) {
            isValid = false;
        }

        if (!isValid && !document.getElementById('error-notification').textContent) {
            document.getElementById('error-notification').textContent = 'Please correct the highlighted errors';
            document.getElementById('error-notification').style.display = 'block';
        }

        return isValid;
    }

    function addItem(listId) {
        const list = document.getElementById(listId);
        const newItem = document.createElement('div');
        newItem.className = 'item';
        newItem.innerHTML = `
            <input type="text" placeholder="Component name" class="component-name">
            <input type="number" placeholder="Amount" min="0" class="component-amount">
            <button type="button" class="remove-item">✕</button>
        `;
        list.appendChild(newItem);
    }

    function previewPayslip() {
        if (validateForm()) {
            const formData = collectFormData();
            populatePreview(formData);
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('preview-container').style.display = 'block';
        }
    }

    function closePreview() {
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('form-container').style.display = 'block';
    }

function savePayslip() {
    if (validateForm()) {
        const formData = collectFormData();
        let payslips = JSON.parse(localStorage.getItem('payslips')) || [];

        // Check for duplicate payslip (same employee ID and month-year)
        const isDuplicate = payslips.some(payslip => 
            payslip.employeeId === formData.employeeId && 
            payslip.monthYear === formData.monthYear
        );

        if (isDuplicate) {
            showNotification('error', 'A payslip for this Employee ID and Month/Year already exists!');
            return;
        }

        // Proceed with saving if no duplicate is found
        formData.id = Date.now().toString();
        formData.createdAt = new Date().toISOString();
        payslips.push(formData);
        localStorage.setItem('payslips', JSON.stringify(payslips));
        populatePreview(formData);
        document.getElementById('form-container').style.display = 'none';
        document.getElementById('preview-container').style.display = 'block';
        loadPayslips();
        showNotification('success', 'Payslip generated and saved successfully!');
        clearForm();
    }
}

    function collectFormData() {
        const monthYear = document.getElementById('month-year').value;
        const date = new Date(monthYear);
        const monthNames = ["January", "February", "March", "April", "May", "June", 
                          "July", "August", "September", "October", "November", "December"];
        const monthYearFormatted = monthNames[date.getMonth()] + ' ' + date.getFullYear();

        const formData = {
            employeeId: document.getElementById('employee-id').value,
            employeeName: document.getElementById('employee-name').value,
            designation: document.getElementById('designation').value,
            dateJoining: document.getElementById('date-joining').value,
            monthYear: monthYear,
            monthYearFormatted: monthYearFormatted,
            employeeType: document.getElementById('employee-type').value,
            location: document.getElementById('location').value,
            bankName: document.getElementById('bank-name').value,
            accountNo: document.getElementById('account-no').value,
            workingDays: document.getElementById('working-days').value,
            lop: document.getElementById('lop').value || '0',
            pan: document.getElementById('pan').value,
            duration: formatDuration(monthYear),
            earnings: [],
            deductions: [],
            grossPay: 0,
            totalDeductions: 0,
            netPay: 0
        };

        document.getElementById('earnings-list').querySelectorAll('.item').forEach(item => {
            const [nameInput, amountInput] = item.querySelectorAll('input');
            const component = nameInput.value;
            const amount = parseFloat(amountInput.value) || 0;
            if (component && !isNaN(amount)) {
                formData.earnings.push({ component, amount });
                formData.grossPay += amount;
            }
        });

        document.getElementById('deductions-list').querySelectorAll('.item').forEach(item => {
            const [nameInput, amountInput] = item.querySelectorAll('input');
            const component = nameInput.value;
            const amount = parseFloat(amountInput.value) || 0;
            if (component && !isNaN(amount)) {
                formData.deductions.push({ component, amount });
                formData.totalDeductions += amount;
            }
        });

        const workingDays = parseFloat(document.getElementById('working-days').value) || 0;
        const lop = parseFloat(document.getElementById('lop').value) || 0;
        const lopDeduction = calculateLOPDeduction(formData.grossPay, workingDays, lop);

        if (lop > 0 && lopDeduction > 0) {
            formData.deductions.push({
                component: 'Loss of Pay (LOP)',
                amount: lopDeduction
            });
            formData.totalDeductions += lopDeduction;
        }

        formData.netPay = formData.grossPay - formData.totalDeductions;

        return formData;
    }

    function formatDuration(monthYear) {
        if (!monthYear) return '';
        const date = new Date(monthYear);
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        return `1st ${firstDay.toLocaleDateString('en-US', { month: 'long' })}, ${year} to ${lastDay.getDate()}${getDaySuffix(lastDay.getDate())} ${lastDay.toLocaleDateString('en-US', { month: 'long' })}, ${year}`;
    }

    function getDaySuffix(day) {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    }

    function downloadPayslip() {
        alert('PDF download functionality would be implemented here using a library like jsPDF');
    }

    function loadPayslips() {
        const payslips = JSON.parse(localStorage.getItem('payslips'));
        const table = document.getElementById('payslips-table');
        table.innerHTML = '';
        if (payslips && payslips.length > 0) {
            payslips.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(payslip => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', payslip.id);
                row.innerHTML = `
                    <td>${payslip.employeeId}</td>
                    <td>${payslip.employeeName}</td>
                    <td>${payslip.monthYearFormatted}</td>
                    <td>₹${payslip.netPay.toFixed(2)}</td>
                    <td>
                        <button class="action-btn view">View</button>
                        <button class="action-btn delete">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }
    }

    function deletePayslip(id) {
        const payslips = JSON.parse(localStorage.getItem('payslips'));
        const updatedPayslips = payslips.filter(p => p.id !== id);
        localStorage.setItem('payslips', JSON.stringify(updatedPayslips));
        loadPayslips();
        showNotification('success', 'Payslip deleted successfully!');
    }

    function viewPayslip(id) {
        const payslips = JSON.parse(localStorage.getItem('payslips'));
        const payslip = payslips.find(p => p.id === id);
        if (payslip) {
            populatePreview(payslip);
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('preview-container').style.display = 'block';
        }
    }

    function clearForm() {
        document.getElementById('employee-id').value = '';
        document.getElementById('employee-name').value = '';
        document.getElementById('designation').value = '';
        document.getElementById('date-joining').value = '';
        document.getElementById('month-year').value = '';
        document.getElementById('employee-type').value = 'Permanent';
        document.getElementById('location').value = '';
        document.getElementById('bank-name').value = '';
        document.getElementById('account-no').value = '';
        document.getElementById('working-days').value = '';
        document.getElementById('lop').value = '';
        document.getElementById('pan').value = '';
        
        document.getElementById('earnings-list').innerHTML = `
            <div class="item">
                <input type="text" placeholder="Component name" value="Basic" class="component-name">
                <input type="number" placeholder="Amount" min="0" class="component-amount">
                <button type="button" class="remove-item">✕</button>
            </div>
            <div class="item">
                <input type="text" placeholder="Component name" value="House Rent Allowance" class="component-name">
                <input type="number" placeholder="Amount" min="0" class="component-amount">
                <button type="button" class="remove-item">✕</button>
            </div>
        `;
        
        document.getElementById('deductions-list').innerHTML = `
            <div class="item">
                <input type="text" placeholder="Component name" value="Professional Tax" class="component-name">
                <input type="number" placeholder="Amount" min="0" class="component-amount">
                <button type="button" class="remove-item">✕</button>
            </div>
        `;

        document.querySelectorAll('.error-message').forEach(msg => msg.textContent = '');
        document.getElementById('error-notification').style.display = 'none';
    }

    function showNotification(type, message) {
        const notification = document.getElementById(`${type}-notification`);
        notification.textContent = message;
        notification.style.display = 'block';
        setTimeout(() => notification.style.display = 'none', 3000);
    }

    document.getElementById('earnings-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            e.target.parentElement.remove();
        }
    });

    document.getElementById('deductions-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            e.target.parentElement.remove();
        }
    });

    document.getElementById('payslips-table').addEventListener('click', function(e) {
        if (e.target.classList.contains('action-btn')) {
            const row = e.target.closest('tr');
            const id = row.getAttribute('data-id');
            if (e.target.classList.contains('delete')) {
                deletePayslip(id);
            } else if (e.target.classList.contains('view')) {
                viewPayslip(id);
            }
        }
    });

    function populatePreview(formData) {
        document.getElementById('preview-month-year').textContent = formData.monthYearFormatted;
        document.getElementById('preview-name').textContent = formData.employeeName;
        document.getElementById('preview-designation').textContent = formData.designation;
        document.getElementById('preview-doj').textContent = formData.dateJoining;
        document.getElementById('preview-bank').textContent = formData.bankName;
        document.getElementById('preview-type').textContent = formData.employeeType;
        document.getElementById('preview-duration').textContent = formData.duration;
        document.getElementById('preview-working-days').textContent = formData.workingDays;
        document.getElementById('preview-account').textContent = formData.accountNo;
        document.getElementById('preview-id').textContent = formData.employeeId;
        document.getElementById('preview-location').textContent = formData.location;
        document.getElementById('preview-lop').textContent = formData.lop;
        document.getElementById('preview-pan').textContent = formData.pan;

        const earningsTable = document.getElementById('preview-earnings-table');
        earningsTable.innerHTML = '';
        formData.earnings.forEach(earning => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${earning.component}</td><td>${earning.amount.toFixed(2)}</td>`;
            earningsTable.appendChild(row);
        });

        const deductionsTable = document.getElementById('preview-deductions-table');
        deductionsTable.innerHTML = '';
        formData.deductions.forEach(deduction => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${deduction.component}</td><td>${deduction.amount.toFixed(2)}</td>`;
            deductionsTable.appendChild(row);
        });

        document.getElementById('preview-gross-pay').textContent = formData.grossPay.toFixed(2);
        document.getElementById('preview-total-deductions').textContent = formData.totalDeductions.toFixed(2);
        document.getElementById('preview-net-pay').textContent = formData.netPay.toFixed(2);
    }
});
    </script>
</body>
</html>
